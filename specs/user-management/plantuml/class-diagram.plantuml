@startuml User & Access Management - Class Diagram

title User & Access Management - Domain Class Diagram

' Styling
skinparam class {
    BackgroundColor<<Entity>> LightBlue
    BackgroundColor<<ValueObject>> LightGreen
    BackgroundColor<<Enum>> LightYellow
    BackgroundColor<<Service>> LightCoral
    BackgroundColor<<Repository>> Wheat
    BorderColor Black
    ArrowColor Black
}

skinparam classAttributeIconSize 0

' ==================== ENTITIES ====================

class User <<Entity>> {
    - Id : Guid
    - Email : Email
    - FirstName : string
    - LastName : string
    - PhoneNumber : string
    - ProfilePictureUrl : string
    - Status : UserStatus
    - CreatedAt : DateTime
    - UpdatedAt : DateTime?
    - LastLoginAt : DateTime?
    - DeactivatedAt : DateTime?
    - DeactivationReason : string
    --
    + Create(email, firstName, lastName) : User
    + UpdateProfile(firstName, lastName, phone) : void
    + Deactivate(reason) : void
    + Reactivate() : void
    + UpdateLastLogin() : void
    + ChangePassword(currentPassword, newPassword) : void
    + AssignRole(role) : void
    + RevokeRole(roleId) : void
    + GrantPermission(permission) : void
    + RevokePermission(permissionId) : void
}

class Role <<Entity>> {
    - Id : Guid
    - Name : string
    - Description : string
    - IsSystemRole : bool
    - CreatedAt : DateTime
    - UpdatedAt : DateTime?
    --
    + Create(name, description) : Role
    + Update(name, description) : void
    + AddPermission(permission) : void
    + RemovePermission(permissionId) : void
    + IsSystemRole() : bool
}

class Permission <<Entity>> {
    - Id : Guid
    - Resource : string
    - Action : string
    - Description : string
    - CreatedAt : DateTime
    --
    + Create(resource, action, description) : Permission
    + Matches(resource, action) : bool
}

class UserRole <<Entity>> {
    - UserId : Guid
    - RoleId : Guid
    - AssignedAt : DateTime
    - AssignedBy : Guid
    --
    + Create(userId, roleId, assignedBy) : UserRole
}

class RolePermission <<Entity>> {
    - RoleId : Guid
    - PermissionId : Guid
    --
    + Create(roleId, permissionId) : RolePermission
}

class UserPermission <<Entity>> {
    - UserId : Guid
    - PermissionId : Guid
    - GrantedAt : DateTime
    - GrantedBy : Guid
    --
    + Create(userId, permissionId, grantedBy) : UserPermission
}

class UserSession <<Entity>> {
    - Id : Guid
    - UserId : Guid
    - RefreshToken : string
    - DeviceInfo : string
    - IpAddress : string
    - CreatedAt : DateTime
    - ExpiresAt : DateTime
    - RevokedAt : DateTime?
    - IsActive : bool
    --
    + Create(userId, refreshToken, deviceInfo, ipAddress) : UserSession
    + Revoke() : void
    + IsExpired() : bool
    + Refresh(newToken, newExpiresAt) : void
}

class UserAuditLog <<Entity>> {
    - Id : Guid
    - UserId : Guid?
    - EventType : string
    - Action : string
    - Details : string
    - IpAddress : string
    - UserAgent : string
    - Timestamp : DateTime
    - IsSuccessful : bool
    - FailureReason : string
    --
    + Create(userId, eventType, action, details) : UserAuditLog
    + SetSuccess() : void
    + SetFailure(reason) : void
}

' ==================== VALUE OBJECTS ====================

class Email <<ValueObject>> {
    - Value : string
    --
    + Create(email) : Email
    + IsValid(email) : bool
    + Equals(other) : bool
    + ToString() : string
}

class Password <<ValueObject>> {
    - Hash : string
    - Salt : string
    --
    + Create(password) : Password
    + Verify(password) : bool
    + IsStrong(password) : bool
}

' ==================== ENUMERATIONS ====================

enum UserStatus <<Enum>> {
    Active
    Inactive
    Deactivated
    Suspended
    Locked
}

enum AuthenticationResult <<Enum>> {
    Success
    InvalidCredentials
    AccountLocked
    AccountDeactivated
    MfaRequired
    PasswordExpired
}

' ==================== DOMAIN EVENTS ====================

abstract class DomainEvent {
    + EventId : Guid
    + OccurredOn : DateTime
    + UserId : Guid?
}

class UserAccountCreated {
    + UserId : Guid
    + Email : string
    + FirstName : string
    + LastName : string
    + CreatedAt : DateTime
}

class UserAccountUpdated {
    + UserId : Guid
    + Changes : Dictionary<string, object>
    + UpdatedAt : DateTime
}

class UserAccountDeactivated {
    + UserId : Guid
    + Reason : string
    + DeactivatedAt : DateTime
}

class UserAccountReactivated {
    + UserId : Guid
    + ReactivatedAt : DateTime
}

class UserPasswordChanged {
    + UserId : Guid
    + ChangedAt : DateTime
}

class UserPasswordReset {
    + UserId : Guid
    + ResetMethod : string
    + ResetAt : DateTime
}

class UserLoginSuccessful {
    + UserId : Guid
    + IpAddress : string
    + DeviceInfo : string
    + LoginAt : DateTime
}

class UserLoginFailed {
    + Email : string
    + Reason : string
    + IpAddress : string
    + AttemptedAt : DateTime
}

class UserLoggedOut {
    + UserId : Guid
    + SessionId : Guid
    + LoggedOutAt : DateTime
}

class UserSessionExpired {
    + UserId : Guid
    + SessionId : Guid
    + ExpiredAt : DateTime
}

class UserRoleAssigned {
    + UserId : Guid
    + RoleId : Guid
    + RoleName : string
    + AssignedBy : Guid
    + AssignedAt : DateTime
}

class UserRoleRevoked {
    + UserId : Guid
    + RoleId : Guid
    + RoleName : string
    + RevokedBy : Guid
    + RevokedAt : DateTime
}

class UserPermissionGranted {
    + UserId : Guid
    + PermissionId : Guid
    + Resource : string
    + Action : string
    + GrantedBy : Guid
    + GrantedAt : DateTime
}

class UserPermissionRevoked {
    + UserId : Guid
    + PermissionId : Guid
    + Resource : string
    + Action : string
    + RevokedBy : Guid
    + RevokedAt : DateTime
}

class UnauthorizedAccessAttempted {
    + UserId : Guid?
    + Resource : string
    + Action : string
    + IpAddress : string
    + AttemptedAt : DateTime
}

' ==================== SERVICES ====================

interface IAuthenticationService <<Service>> {
    + AuthenticateAsync(email, password) : Task<AuthenticationResult>
    + GenerateAccessTokenAsync(user) : Task<string>
    + GenerateRefreshTokenAsync(user) : Task<string>
    + ValidateRefreshTokenAsync(refreshToken) : Task<bool>
    + RevokeRefreshTokenAsync(refreshToken) : Task
}

interface IPasswordService <<Service>> {
    + HashPassword(password, salt) : string
    + VerifyPassword(password, hash, salt) : bool
    + ValidatePasswordStrength(password) : bool
    + GeneratePasswordResetTokenAsync(user) : Task<string>
    + ValidatePasswordResetTokenAsync(token) : Task<bool>
}

interface IAuthorizationService <<Service>> {
    + HasPermissionAsync(userId, resource, action) : Task<bool>
    + GetEffectivePermissionsAsync(userId) : Task<IEnumerable<Permission>>
    + IsInRoleAsync(userId, roleName) : Task<bool>
}

interface ISessionService <<Service>> {
    + CreateSessionAsync(user, deviceInfo, ipAddress) : Task<UserSession>
    + RevokeSessionAsync(sessionId) : Task
    + RevokeAllUserSessionsAsync(userId) : Task
    + IsSessionActiveAsync(sessionId) : Task<bool>
    + CleanupExpiredSessionsAsync() : Task
}

interface IAuditService <<Service>> {
    + LogEventAsync(domainEvent) : Task
    + LogUnauthorizedAccessAsync(userId, resource, action, ipAddress) : Task
    + GetUserAuditLogsAsync(userId, filter) : Task<PagedResult<UserAuditLog>>
}

' ==================== REPOSITORIES ====================

interface IUserRepository <<Repository>> {
    + GetByIdAsync(id) : Task<User>
    + GetByEmailAsync(email) : Task<User>
    + GetAllAsync(filter) : Task<PagedResult<User>>
    + AddAsync(user) : Task
    + UpdateAsync(user) : Task
    + DeleteAsync(id) : Task
    + ExistsAsync(email) : Task<bool>
}

interface IRoleRepository <<Repository>> {
    + GetByIdAsync(id) : Task<Role>
    + GetByNameAsync(name) : Task<Role>
    + GetAllAsync() : Task<IEnumerable<Role>>
    + AddAsync(role) : Task
    + UpdateAsync(role) : Task
    + DeleteAsync(id) : Task
}

interface IPermissionRepository <<Repository>> {
    + GetByIdAsync(id) : Task<Permission>
    + GetByResourceActionAsync(resource, action) : Task<Permission>
    + GetAllAsync() : Task<IEnumerable<Permission>>
    + AddAsync(permission) : Task
}

interface ISessionRepository <<Repository>> {
    + GetByIdAsync(id) : Task<UserSession>
    + GetByRefreshTokenAsync(token) : Task<UserSession>
    + GetUserSessionsAsync(userId) : Task<IEnumerable<UserSession>>
    + AddAsync(session) : Task
    + UpdateAsync(session) : Task
    + DeleteExpiredSessionsAsync() : Task
}

interface IAuditLogRepository <<Repository>> {
    + GetByIdAsync(id) : Task<UserAuditLog>
    + GetUserLogsAsync(userId, filter) : Task<PagedResult<UserAuditLog>>
    + GetUnauthorizedAttemptsAsync(filter) : Task<PagedResult<UserAuditLog>>
    + AddAsync(log) : Task
}

' ==================== RELATIONSHIPS ====================

' User relationships
User "1" *-- "0..*" UserRole : has
User "1" *-- "0..*" UserPermission : has
User "1" *-- "0..*" UserSession : has
User "1" *-- "0..*" UserAuditLog : has
User *-- Email : has
User -- UserStatus : has

' Role relationships
Role "1" *-- "0..*" UserRole : assigned to
Role "1" *-- "0..*" RolePermission : has

' Permission relationships
Permission "1" *-- "0..*" RolePermission : granted to
Permission "1" *-- "0..*" UserPermission : granted to

' UserRole relationships
UserRole "*" -- "1" User
UserRole "*" -- "1" Role

' RolePermission relationships
RolePermission "*" -- "1" Role
RolePermission "*" -- "1" Permission

' UserPermission relationships
UserPermission "*" -- "1" User
UserPermission "*" -- "1" Permission

' UserSession relationships
UserSession "*" -- "1" User

' UserAuditLog relationships
UserAuditLog "*" -- "0..1" User

' Domain Events inheritance
DomainEvent <|-- UserAccountCreated
DomainEvent <|-- UserAccountUpdated
DomainEvent <|-- UserAccountDeactivated
DomainEvent <|-- UserAccountReactivated
DomainEvent <|-- UserPasswordChanged
DomainEvent <|-- UserPasswordReset
DomainEvent <|-- UserLoginSuccessful
DomainEvent <|-- UserLoginFailed
DomainEvent <|-- UserLoggedOut
DomainEvent <|-- UserSessionExpired
DomainEvent <|-- UserRoleAssigned
DomainEvent <|-- UserRoleRevoked
DomainEvent <|-- UserPermissionGranted
DomainEvent <|-- UserPermissionRevoked
DomainEvent <|-- UnauthorizedAccessAttempted

' Service dependencies
IAuthenticationService ..> User : uses
IAuthenticationService ..> UserSession : creates
IPasswordService ..> Password : uses
IAuthorizationService ..> Permission : uses
IAuthorizationService ..> Role : uses
ISessionService ..> UserSession : manages
IAuditService ..> UserAuditLog : creates

' Repository dependencies
IUserRepository ..> User : manages
IRoleRepository ..> Role : manages
IPermissionRepository ..> Permission : manages
ISessionRepository ..> UserSession : manages
IAuditLogRepository ..> UserAuditLog : manages

note top of User
    Aggregate Root
    - Manages user account lifecycle
    - Enforces business rules
    - Publishes domain events
end note

note top of Role
    Entity
    - System roles cannot be deleted
    - Permissions inherited by users
end note

note top of Permission
    Entity
    - Resource-Action based
    - Immutable after creation
end note

note top of Email
    Value Object
    - Validated on creation
    - Immutable
    - Case-insensitive comparison
end note

note top of Password
    Value Object
    - Always hashed
    - Never stored in plain text
    - Salted using BCrypt
end note

@enduml
